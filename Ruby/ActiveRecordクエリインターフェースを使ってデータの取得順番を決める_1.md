# 2025/3/8 Active Recordクエリインターフェースを使ったデータ並べ替えPart1
## 実装の目的：実装済みの本の投稿SNSサイトの投稿一覧を、１週間ごとのいいね数が多い順に並べ替える
### これをやるとざっくりどうなる？：
#### SNSサイトの投稿一覧データ表示順が、１週間毎（今回は日曜日を基準日に整理）にいいね数が多い順に並び替えられる。
----------------------------
### やろうとしていること
### 前提条件
#### データを並び替える方法はその条件によって色々考えられそうだが、DMMのカリキュラムに沿って必須の条件を整理する。
#### 条件:１週間毎の合計のいいね数が多い順に並べること
#### ※どこを基準に１週間とするかは特に指定がなかったので、日曜日を基準に整理。
### 注意すること！！
#### １週間毎の合計で並び替えを行うと、期間の間に新規作成されたレコードが集計対象外にならないように考慮が必要！
#### 今回の実装も、最初この考慮を入れなかったために、新規作成した本がIndexに表示されなくなってしまったので気を付ける。
----------------------------
#### 実際にBookモデルに実装したメソッドは以下の通り。
####  #基準日から1週間分のいいね数を集計するためのメソッド
####  scope :by_weekly_favorites_count, -> {
####      start_date = Date.current.beginning_of_week　　→ １週間のスタート日＝日曜日　の日付定義を行う。
####       end_date = Date.current.end_of_week　→ １週間の終了日＝土曜日　の日付定義を行う。
####
####    left_joins(:favorites)
####      .where(favorites: { created_at: start_date..end_date }).or(where(favorites:{ id: nil }))
####      .group(:id)　→Book.id毎に集計する。
####      .order('COUNT(favorites.id) DESC')→データが多い順（＝降順）にカウントした結果を並べる。
####  }
--------------------------
### Bookモデルに指定したメソッドの使い方
### 今回は投稿一覧（Indexビュー）のデータの並べ替えなので、booksコントローラに作ったindexメソッドの以下の定義を変更。
### （変更前）
#### books = Book.all
####  @books = Book.all
### (変更後)
#### books = Book.by_weekly_favorites_count
#### @books = Book.by_weekly_favorites_count

#### （後日サンプルコードで復習したら内容次第で更新予定。）
-------------------------

